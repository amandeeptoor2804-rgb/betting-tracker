<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Betting Ledger</title>
<meta name="theme-color" content="#020817" />
<style>
:root{
  --bg:#020817;
  --card:#0f172a;
  --border:#1f2937;
  --fg:#e5e7eb;
  --muted:#9ca3af;
  --accent:#22c55e;
  --accent-soft:#064e3b;
  --danger:#ef4444;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--fg);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
}
.container{
  max-width:980px;
  margin:0 auto;
  padding:12px;
}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px;
  margin-top:10px;
}
h1,h2,h3{
  margin:4px 0 8px;
  font-weight:600;
}
.small{
  font-size:12px;
  color:var(--muted);
}
button,input,select,textarea{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#020817;
  color:var(--fg);
  font:inherit;
}
button{
  cursor:pointer;
  font-weight:700;
  background:var(--accent);
  color:#022c22;
  border-color:#16a34a;
  transition:transform .05s;
}
button:active{transform:scale(.98)}
button.secondary{
  background:#111827;
  color:var(--fg);
}
button.danger{
  background:var(--danger);
  color:#111827;
  border-color:#b91c1c;
}
.grid{display:grid;gap:8px}
.cols-2{grid-template-columns:1fr 1fr}
.cols-3{grid-template-columns:repeat(3,1fr)}
.summary{
  display:grid;
  gap:8px;
  grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  margin-top:6px;
}
.sum{
  background:#020817;
  border:1px solid var(--border);
  border-radius:12px;
  padding:8px;
}
.sum .lab{
  font-size:10px;
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:.04em;
}
.sum .val{
  margin-top:4px;
  font-size:17px;
  font-weight:800;
}
.tabs{
  display:flex;
  gap:6px;
  overflow-x:auto;
  padding:4px 0;
}
.tab{
  flex:0 0 auto;
  padding:6px 12px;
  border:1px solid var(--border);
  border-radius:999px;
  background:#020817;
  color:var(--muted);
  font-size:11px;
  white-space:nowrap;
  cursor:pointer;
}
.tab.active{
  background:var(--accent-soft);
  color:var(--accent);
  border-color:var(--accent);
}
.list{
  display:flex;
  flex-direction:column;
  gap:8px;
  margin-top:8px;
}
.row{
  border:1px solid var(--border);
  border-radius:12px;
  background:#0b142f;
  padding:10px;
}
.rowTop{
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:center;
}
.title{font-weight:700}
.meta{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  line-height:1.3;
  margin-top:6px;
  font-size:12px;
  color:var(--muted);
}
.pill{
  padding:4px 10px;
  border:1px solid var(--border);
  border-radius:999px;
  background:#020817;
}
.good{color:#22c55e}
.bad{color:#ef4444}
.actions{
  display:flex;
  gap:6px;
  margin-top:8px;
}
.actions .btn{
  flex:1;
  border-radius:999px;
  padding:10px;
  font-weight:700;
}
.details{
  margin-top:8px;
  padding:8px;
  border:1px dashed var(--border);
  border-radius:10px;
  display:none;
}
.details.show{display:block}
.kv{
  display:grid;
  grid-template-columns:120px 1fr;
  gap:6px;
  margin-top:4px;
}
.feesList{margin-top:8px}
.feesList .feeItem{
  border:1px solid var(--border);
  border-radius:10px;
  padding:8px;
  margin-top:6px;
  background:#0b142f;
}

/* --- Responsive stacking for phones --- */
@media (max-width:820px){
  .cols-3{grid-template-columns:1fr 1fr}
}
@media (max-width:640px){
  .cols-2,.cols-3{grid-template-columns:1fr}
  .rowTop{flex-wrap:wrap;gap:6px}
  .title{font-size:14px}
  .actions{flex-direction:column}
  .actions .btn{width:100%}
  .details .kv{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="container">

  <!-- LOGIN -->
  <section id="loginCard" class="card">
    <h1>Betting Ledger</h1>
    <p class="small">
      Sign in with the same Firebase email/password.
      Separate from your trading journal &amp; expense tracker.
    </p>
    <input id="email" type="email" placeholder="Email" autocomplete="username" />
    <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
    <button id="loginBtn">Login</button>
    <p id="loginErr" class="small" style="color:#fca5a5;"></p>
  </section>

  <!-- APP -->
  <section id="appCard" class="card" style="display:none;">
    <div class="grid cols-2" style="align-items:center">
      <div>
        <h2>Dashboard</h2>
        <div id="userEmail" class="small"></div>
      </div>
      <div class="right">
        <button id="logoutBtn" class="secondary">Logout</button>
      </div>
    </div>

    <!-- SUMMARY -->
    <div class="summary">
      <div class="sum"><div class="lab">Total Bets</div><div id="sBets" class="val">0</div></div>
      <div class="sum"><div class="lab">Hit Rate</div><div id="sHit" class="val">0%</div></div>
      <div class="sum"><div class="lab">Total Stake</div><div id="sStake" class="val">$0.00</div></div>
      <div class="sum"><div class="lab">Profit</div><div id="sProfit" class="val">$0.00</div></div>
      <div class="sum"><div class="lab">Loss</div><div id="sLoss" class="val">$0.00</div></div>
      <div class="sum"><div class="lab">Net P/L</div><div id="sPL" class="val">$0.00</div></div>
      <div class="sum"><div class="lab">Withdrawals</div><div id="sWdr" class="val">$0.00</div></div>
      <div class="sum"><div class="lab">Fees Paid (bank)</div><div id="sFees" class="val">$0.00</div></div>
      <div class="sum"><div class="lab">Net After Fees</div><div id="sAfterFees" class="val">$0.00</div></div>
    </div>

    <!-- Scope + source summary -->
    <p id="scopeSummary" class="small" style="margin-top:4px;">
      Showing <strong>All dates</strong>, <strong>all sources</strong>, all statuses.
    </p>
    <p id="sourcePL" class="small" style="margin-top:2px;"></p>

    <!-- BALANCES -->
    <div class="summary" style="margin-top:6px">
      <div class="sum">
        <div class="lab">Starting Balance</div>
        <div class="grid cols-2" style="gap:6px;margin-top:6px">
          <input id="startBalance" type="number" step="0.01" />
          <button id="saveStart" class="secondary">Save</button>
        </div>
      </div>
      <div class="sum"><div class="lab">Stake Bankroll</div><div id="sBankroll" class="val">$0.00</div></div>
      <div class="sum"><div class="lab">Fees Bank Total</div><div id="sFeesBank" class="val">$0.00</div></div>
    </div>

    <!-- FILTER BAR -->
    <div class="card">
      <div class="tabs" id="dateTabs"></div>
      <div class="grid cols-2">
        <select id="sourceFilter">
          <option value="all">All Sources</option>
          <option>ODDS BREAKER</option>
          <option>SNEWJ PROMPS</option>
          <option>Unknown</option>
          <option value="__custom">Other (custom)</option>
        </select>
        <select id="statusFilter">
          <option value="all">All Status</option>
          <option value="pending">Pending</option>
          <option value="won">Won</option>
          <option value="lost">Lost</option>
          <option value="void">Void</option>
          <option value="cashed">Cashed</option>
        </select>
      </div>
    </div>

    <!-- ADD BET -->
    <div class="card">
      <h3>Add Bet</h3>
      <div class="grid cols-2">
        <div>
          <div class="small">Date</div>
          <input id="betDate" type="date" />
        </div>
        <div>
          <div class="small">Source</div>
          <select id="betSource">
            <option>ODDS BREAKER</option>
            <option>SNEWJ PROMPS</option>
            <option>Unknown</option>
            <option value="__custom">Other (custom)</option>
          </select>
          <input id="betSourceCustom" placeholder="Type source…" style="display:none;margin-top:6px">
        </div>
      </div>
      <div class="grid cols-2" style="margin-top:6px">
        <div>
          <div class="small">Event / Match</div>
          <input id="betEvent" placeholder="e.g., Bulls vs Pistons" />
        </div>
        <div>
          <div class="small">Selection</div>
          <input id="betSelection" placeholder="e.g., Pistons ML" />
        </div>
      </div>
      <div class="grid cols-3" style="margin-top:6px">
        <div>
          <div class="small">Stake</div>
          <input id="betStake" type="number" step="0.01" />
        </div>
        <div>
          <div class="small">Odds</div>
          <input id="betOdds" type="number" step="0.01" />
        </div>
        <div>
          <div class="small">Withdrawal (optional)</div>
          <input id="betWdr" type="number" step="0.01" />
        </div>
      </div>
      <div class="grid cols-3" style="margin-top:6px">
        <div>
          <div class="small">Result</div>
          <select id="betResult">
            <option value="pending">Pending</option>
            <option value="won">Won</option>
            <option value="lost">Lost</option>
            <option value="void">Void</option>
            <option value="cashed">Cashed</option>
          </select>
        </div>
        <div>
          <div class="small">Cash-out Return</div>
          <input id="betCashReturn" type="number" step="0.01" placeholder="only if Cashed" />
        </div>
        <div>
          <div class="small">Fee Applied to this pick</div>
          <input id="betFeeApplied" type="number" step="0.01" placeholder="optional" />
        </div>
      </div>
      <div style="margin-top:6px">
        <div class="small">Notes</div>
        <textarea id="betNotes" rows="2"></textarea>
      </div>
      <button id="addBet" style="margin-top:8px">Save Bet</button>
      <p id="addErr" class="small" style="color:#fca5a5"></p>
    </div>

    <!-- FEES (BANK) -->
    <div class="card">
      <h3>Membership Fees (Paid from BANK)</h3>
      <div class="grid cols-3">
        <div>
          <div class="small">Date</div>
          <input id="feeDate" type="date" />
        </div>
        <div>
          <div class="small">Amount</div>
          <input id="feeAmount" type="number" step="0.01" />
        </div>
        <div>
          <div class="small">Source (optional)</div>
          <input id="feeSource" placeholder="e.g., ODDS BREAKER" />
        </div>
      </div>
      <div style="margin-top:6px">
        <div class="small">Notes</div>
        <input id="feeNotes" />
      </div>
      <button id="addFee" class="secondary" style="margin-top:8px">Add Fee</button>
      <div class="feesList" id="feesList"></div>
    </div>

    <!-- LIST -->
    <div class="card">
      <h3>Bets</h3>
      <div id="list" class="list"></div>
    </div>

  </section>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  doc,
  getDoc,
  setDoc,
  updateDoc,
  deleteDoc,
  serverTimestamp,
  query,
  where,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

/* Firebase config (exact) */
const firebaseConfig = {
  apiKey: "AIzaSyB5rvkKPst6V9-7HoqK1f27jQj6x7f8LiA",
  authDomain: "trading-journal-da4eb.firebaseapp.com",
  projectId: "trading-journal-da4eb",
  storageBucket: "trading-journal-da4eb.firebasestorage.app",
  messagingSenderId: "50906470929",
  appId: "1:50906470929:web:b9ad784e9ae86c06d42fb0",
  measurementId: "G-WR261BKTXL"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

const $   = id => document.getElementById(id);
const fmt = n => "$" + (Number(n)||0).toFixed(2);
const today = () => new Date().toISOString().slice(0,10);

$("betDate").value = today();
$("feeDate").value = today();

/* ---------------- AUTH ---------------- */
$("loginBtn").onclick = async () => {
  $("loginErr").textContent = "";
  try {
    await signInWithEmailAndPassword(
      auth,
      $("email").value.trim(),
      $("password").value
    );
  } catch(e){
    $("loginErr").textContent = e.message || "Login failed";
  }
};
$("logoutBtn").onclick = () => signOut(auth);

onAuthStateChanged(auth, async user => {
  if (user){
    $("loginCard").style.display = "none";
    $("appCard").style.display   = "block";
    $("userEmail").textContent   = user.email || "";
    await loadSettings();
    await refreshAll();
  } else {
    $("appCard").style.display   = "none";
    $("loginCard").style.display = "block";
  }
});

/* -------- Settings (starting balance) -------- */
async function loadSettings(){
  const uid = auth.currentUser.uid;
  const ref = doc(db,"betting_settings",uid);
  const snap = await getDoc(ref);
  if (!snap.exists()){
    await setDoc(ref,{
      ownerUid:uid,
      startingBalance:0,
      createdAt:serverTimestamp()
    });
    $("startBalance").value = 0;
  } else {
    $("startBalance").value = Number(snap.data().startingBalance)||0;
  }
}
$("saveStart").onclick = async () => {
  const uid = auth.currentUser.uid;
  await setDoc(
    doc(db,"betting_settings",uid),
    {
      ownerUid:uid,
      startingBalance:Number($("startBalance").value||0),
      updatedAt:serverTimestamp()
    },
    {merge:true}
  );
  await refreshAll();
};

/* ------------ Add Bet ------------- */
$("betSource").onchange = () => {
  $("betSourceCustom").style.display =
    $("betSource").value === "__custom" ? "block" : "none";
};

$("addBet").onclick = async () => {
  const user = auth.currentUser;
  if (!user) { alert("Please sign in again."); return; }

  const date   = $("betDate").value || today();
  const srcSel = $("betSource").value;
  const source = srcSel === "__custom"
    ? ($("betSourceCustom").value.trim() || "Other")
    : srcSel;

  const event     = $("betEvent").value.trim();
  const selection = $("betSelection").value.trim();
  const stake     = Number($("betStake").value || 0);
  const odds      = Number($("betOdds").value || 0);
  const withdrawal= Number($("betWdr").value || 0);
  const result    = $("betResult").value;
  const cashReturn= Number($("betCashReturn").value || 0);
  const feeApplied= Number($("betFeeApplied").value || 0);
  const notes     = $("betNotes").value.trim();

  if (!event || !selection || !stake || !odds) {
    alert("Please fill Event, Selection, Stake and Odds.");
    return;
  }

  let pnl = 0;
  if (result === "cashed") pnl = cashReturn - stake;
  else if (result === "won") pnl = (odds - 1) * stake;
  else if (result === "lost") pnl = -stake;
  else pnl = 0;

  try {
    await addDoc(collection(db, "betting_trades"), {
      ownerUid: user.uid,
      date,
      source,
      event,
      selection,
      stake,
      odds,
      result,
      cashReturn,
      withdrawal,
      feeApplied,
      pnl,
      notes,
      createdAt: serverTimestamp()
    });

    ["betStake","betOdds","betWdr","betCashReturn","betFeeApplied","betNotes"]
      .forEach(id => $(id).value = "");

    await refreshAll();
    alert("Saved ✅");
  } catch (err) {
    console.error(err);
    alert("Save failed: " + (err.message || err));
  }
};

/* ------------ Add Fee (bank) ------------- */
$("addFee").onclick = async () => {
  const uid = auth.currentUser.uid;
  const date   = $("feeDate").value || today();
  const amount = Number($("feeAmount").value||0);
  if (!amount) return;
  const source = $("feeSource").value.trim() || null;
  const notes  = $("feeNotes").value.trim() || null;

  await addDoc(collection(db,"betting_fees"),{
    ownerUid:uid,
    date,
    amount,
    source,
    notes,
    createdAt:serverTimestamp()
  });

  $("feeAmount").value="";
  $("feeSource").value="";
  $("feeNotes").value="";
  await refreshAll();
};

/* ---------- Load + render all ---------- */
const state = { selectedDate:"all" };

["statusFilter","sourceFilter"].forEach(id => {
  $(id).onchange = () => refreshAll();
});

async function refreshAll(){
  const uid = auth.currentUser.uid;

  // Load bets
  const tSnap = await getDocs(
    query(collection(db,"betting_trades"), where("ownerUid","==",uid))
  );

  // NORMALISE old + new docs so your history still works
  const allBets = tSnap.docs.map(d => {
    const data = d.data();
    // derive pnl if missing
    let pnl = data.pnl;
    if (pnl === undefined) {
      if (data.profitLoss !== undefined) pnl = data.profitLoss;
      else {
        const stake = Number(data.stake || 0);
        const odds  = Number(data.odds || 0);
        pnl = (odds - 1) * stake; // fallback
      }
    }
    // guess result for very old docs
    let result = data.result;
    if (!result) {
      if (pnl > 0) result = "won";
      else if (pnl < 0) result = "lost";
      else result = "pending";
    }
    return {
      id: d.id,
      ...data,
      event: data.event ?? data.match ?? "",
      selection: data.selection ?? data.pick ?? "",
      pnl,
      result
    };
  });

  // Load fees
  const fSnap = await getDocs(
    query(collection(db,"betting_fees"),
      where("ownerUid","==",uid),
      orderBy("date","asc"))
  );
  const fees = fSnap.docs.map(d => ({id:d.id, ...d.data()}));

  buildDateTabs(allBets);
  renderFees(fees);
  renderListAndSummary(allBets, fees);
}

/* ---------- Date tabs ---------- */
function buildDateTabs(bets){
  const tabs = $("dateTabs");
  tabs.innerHTML = "";
  const dates = Array.from(new Set(bets.map(b=>b.date).filter(Boolean)))
    .sort((a,b)=>b.localeCompare(a));

  const make = (label,val) => {
    const el = document.createElement("div");
    el.className = "tab" + (state.selectedDate===val?" active":"");
    el.textContent = label;
    el.onclick = () => { state.selectedDate = val; refreshAll(); };
    tabs.appendChild(el);
  };
  make("All","all");
  dates.forEach(d => make(d,d));
}

/* ---------- List + summary ---------- */
function renderListAndSummary(allBets, fees){
  // filters
  let bets = [...allBets];

  // For scope & source view we also need set of bets filtered only by date
  let dateFiltered = [...allBets];
  if (state.selectedDate !== "all") {
    bets         = bets.filter(b => b.date === state.selectedDate);
    dateFiltered = dateFiltered.filter(b => b.date === state.selectedDate);
  }

  const sf = $("sourceFilter").value;
  if (sf !== "all"){
    const matchSrc = b => (
      sf === "__custom"
        ? (b.source!=="ODDS BREAKER" && b.source!=="SNEWJ PROMPS" && b.source!=="Unknown")
        : b.source === sf
    );
    bets = bets.filter(matchSrc);
  }

  const st = $("statusFilter").value;
  if (st !== "all") bets = bets.filter(b => b.result === st);

  // LIST
  const wrap = $("list");
  wrap.innerHTML = "";

  bets.sort((a,b) =>
    (b.date||"").localeCompare(a.date||"") ||
    (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0)
  );

  bets.forEach(b => {
    const pnlAfter = Number(b.pnl||0) - Number(b.feeApplied||0);
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div class="rowTop">
        <div class="title">${b.event || "—"} — <span>${b.selection||""}</span></div>
        <div class="pill">${b.source || "Unknown"}</div>
      </div>
      <div class="meta">
        <span>Odds: <b>${Number(b.odds||0).toFixed(2)}</b></span>
        <span>Stake: <b>${fmt(b.stake)}</b></span>
        <span>P/L: <b class="${(b.pnl||0)>=0?'good':'bad'}">${fmt(b.pnl)}</b></span>
        <span>Fee: <b>${fmt(b.feeApplied||0)}</b></span>
        <span>After Fees: <b class="${pnlAfter>=0?'good':'bad'}">${fmt(pnlAfter)}</b></span>
        <span>Status: <b>${b.result}</b>${b.result==='cashed' ? ` (Return ${fmt(b.cashReturn||0)})` : ""}</span>
        ${b.withdrawal ? `<span>Withdrawal: <b>${fmt(b.withdrawal)}</b></span>` : ""}
      </div>
      <div class="actions">
        <button class="btn secondary">Details</button>
        <button class="btn" data-act="save">Save</button>
        <button class="btn danger" data-act="del">Delete</button>
      </div>
      <div class="details">
        <div class="kv"><div>Date</div><div><input class="i-date" type="date" value="${b.date||""}"></div></div>
        <div class="kv"><div>Source</div><div><input class="i-source" value="${b.source||"Unknown"}"></div></div>
        <div class="kv"><div>Event</div><div><input class="i-event" value="${b.event||""}"></div></div>
        <div class="kv"><div>Selection</div><div><input class="i-sel" value="${b.selection||""}"></div></div>
        <div class="kv"><div>Stake</div><div><input class="i-stake" type="number" step="0.01" value="${b.stake||0}"></div></div>
        <div class="kv"><div>Odds</div><div><input class="i-odds" type="number" step="0.01" value="${b.odds||0}"></div></div>
        <div class="kv"><div>Result</div>
          <div>
            <select class="i-res">
              <option value="pending" ${b.result==="pending"?"selected":""}>Pending</option>
              <option value="won" ${b.result==="won"?"selected":""}>Won</option>
              <option value="lost" ${b.result==="lost"?"selected":""}>Lost</option>
              <option value="void" ${b.result==="void"?"selected":""}>Void</option>
              <option value="cashed" ${b.result==="cashed"?"selected":""}>Cashed</option>
            </select>
          </div>
        </div>
        <div class="kv"><div>Cash-out Return</div><div><input class="i-ret" type="number" step="0.01" value="${b.cashReturn||0}"></div></div>
        <div class="kv"><div>Fee Applied</div><div><input class="i-fee" type="number" step="0.01" value="${b.feeApplied||0}"></div></div>
        <div class="kv"><div>Withdrawal</div><div><input class="i-wdr" type="number" step="0.01" value="${b.withdrawal||0}"></div></div>
        <div class="kv"><div>Notes</div><div><textarea class="i-notes" rows="2">${b.notes||""}</textarea></div></div>
      </div>
    `;
    const details = row.querySelector(".details");
    row.querySelector(".secondary").onclick = () => {
      details.classList.toggle("show");
    };
    row.querySelector("[data-act='del']").onclick = async () => {
      if (!confirm("Delete bet?")) return;
      await deleteDoc(doc(db,"betting_trades",b.id));
      refreshAll();
    };
    row.querySelector("[data-act='save']").onclick = async () => {
      const nd   = row.querySelector(".i-date").value || b.date;
      const nsrc = row.querySelector(".i-source").value || "Unknown";
      const nev  = row.querySelector(".i-event").value;
      const nsel = row.querySelector(".i-sel").value;
      const nst  = Number(row.querySelector(".i-stake").value||0);
      const nods = Number(row.querySelector(".i-odds").value||0);
      const nres = row.querySelector(".i-res").value;
      const nret = Number(row.querySelector(".i-ret").value||0);
      const nfee = Number(row.querySelector(".i-fee").value||0);
      const nwdr = Number(row.querySelector(".i-wdr").value||0);
      const nnotes = row.querySelector(".i-notes").value;

      let npl = 0;
      if (nres==="cashed") npl = nret - nst;
      else if (nres==="won") npl = (nods - 1) * nst;
      else if (nres==="lost") npl = -nst;
      else npl = 0;

      await updateDoc(doc(db,"betting_trades",b.id),{
        date:nd,
        source:nsrc,
        event:nev,
        selection:nsel,
        stake:nst,
        odds:nods,
        result:nres,
        cashReturn:nret,
        feeApplied:nfee,
        withdrawal:nwdr,
        pnl:npl,
        notes:nnotes
      });
      refreshAll();
    };

    wrap.appendChild(row);
  });

  /* ---- Summary numbers (based on filtered bets) ---- */
  const totals = bets.reduce((a,b)=>{
    const pl = Number(b.pnl||0);
    a.bets++;
    a.stake += Number(b.stake||0);
    if (pl>0){ a.profit += pl; a.wins++; }
    if (pl<0){ a.loss   += pl; a.losses++; }
    a.pl += pl;
    a.withdraw += Number(b.withdrawal||0);
    a.feeApplied += Number(b.feeApplied||0);
    return a;
  },{
    bets:0,
    stake:0,
    profit:0,
    loss:0,
    pl:0,
    withdraw:0,
    feeApplied:0,
    wins:0,
    losses:0
  });

  const feesBank = fees.reduce((s,f)=> s + Number(f.amount||0), 0);

  const startBal = Number($("startBalance").value||0);
  const bankroll = startBal + totals.pl - totals.withdraw; // fees don't touch stake bankroll
  const afterFees = totals.pl - (feesBank + totals.feeApplied);
  const hitRate = totals.bets ? Math.round((totals.wins / totals.bets)*100) : 0;

  $("sBets").textContent   = String(totals.bets);
  $("sHit").textContent    = hitRate + "%";
  $("sStake").textContent  = fmt(totals.stake);
  $("sProfit").textContent = fmt(totals.profit);
  $("sLoss").textContent   = fmt(Math.abs(totals.loss));
  $("sPL").textContent     = fmt(totals.pl);
  $("sWdr").textContent    = fmt(totals.withdraw);
  $("sFees").textContent   = fmt(feesBank + totals.feeApplied);
  $("sAfterFees").textContent = fmt(afterFees);
  $("sBankroll").textContent  = fmt(bankroll);
  $("sFeesBank").textContent  = fmt(feesBank);

  /* ---- Scope label ---- */
  const dateLabel =
    state.selectedDate === "all" ? "All dates" : state.selectedDate;
  const sfVal = $("sourceFilter").value;
  let srcLabel = "all sources";
  if (sfVal === "ODDS BREAKER") srcLabel = "ODDS BREAKER";
  else if (sfVal === "SNEWJ PROMPS") srcLabel = "SNEWJ PROMPS";
  else if (sfVal === "Unknown") srcLabel = "Unknown";
  else if (sfVal === "__custom") srcLabel = "custom sources";
  $("scopeSummary").innerHTML =
    `Showing <strong>${dateLabel}</strong>, <strong>${srcLabel}</strong>, ` +
    ( $("statusFilter").value === "all"
      ? "all statuses."
      : `status <strong>${$("statusFilter").value}</strong>.`
    );

  /* ---- Source P/L breakdown (per date tab) ---- */
  const sfilt = $("sourceFilter").value;

  // work on dateFiltered (only date tab applied)
  const forDate = dateFiltered;

  if (sfilt === "all") {
    // show breakdown for each source on this date tab
    const bySrc = {};
    forDate.forEach(b=>{
      const src = b.source || "Unknown";
      bySrc[src] = (bySrc[src] || 0) + Number(b.pnl||0);
    });
    const parts = Object.entries(bySrc)
      .sort((a,b)=>Math.abs(b[1]) - Math.abs(a[1]))
      .map(([src,pl]) =>
        `${src}: <span class="${pl>=0?"good":"bad"}">${fmt(pl)}</span>`
      );
    $("sourcePL").innerHTML =
      parts.length
        ? `Source P/L for this date tab: ${parts.join(" · ")}`
        : "No bets yet for this date tab.";
  } else {
    // show only the chosen source P/L on this date tab
    const matchSrc = b => (
      sfilt === "__custom"
        ? (b.source!=="ODDS BREAKER" && b.source!=="SNEWJ PROMPS" && b.source!=="Unknown")
        : b.source === sfilt
    );
    const sum = forDate
      .filter(matchSrc)
      .reduce((s,b)=> s + Number(b.pnl||0), 0);
    const label =
      sfilt === "__custom" ? "Custom sources" : sfilt;
    $("sourcePL").innerHTML =
      `${label} P/L for this date tab: ` +
      `<span class="${sum>=0?"good":"bad"}">${fmt(sum)}</span>`;
  }
}

/* ---------- Fees list render ---------- */
function renderFees(fees){
  const box = $("feesList");
  box.innerHTML = "";
  fees.sort((a,b)=> (a.date||"").localeCompare(b.date||""));
  fees.forEach(f => {
    const div = document.createElement("div");
    div.className = "feeItem";
    div.innerHTML = `
      <div class="meta">
        <b>${f.date}</b> · ${fmt(f.amount)}
        ${f.source ? (" · " + f.source) : ""}
      </div>
      ${f.notes ? `<div class="small" style="margin-top:4px">${f.notes}</div>` : ""}
      <div class="actions" style="margin-top:6px">
        <button class="btn secondary" data-a="edit">Edit</button>
        <button class="btn danger" data-a="del">Delete</button>
      </div>
    `;
    div.querySelector("[data-a='del']").onclick = async () => {
      if (!confirm("Delete fee?")) return;
      await deleteDoc(doc(db,"betting_fees",f.id));
      refreshAll();
    };
    div.querySelector("[data-a='edit']").onclick = async () => {
      const nd = prompt("Date (YYYY-MM-DD)", f.date) || f.date;
      const na = Number(prompt("Amount", f.amount) || f.amount);
      const ns = prompt("Source (optional)", f.source || "") || null;
      const nn = prompt("Notes (optional)", f.notes || "") || null;
      await updateDoc(doc(db,"betting_fees",f.id),{
        date:nd,
        amount:na,
        source:ns,
        notes:nn
      });
      refreshAll();
    };
    box.appendChild(div);
  });
}
</script>
</body>
</html>
