<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Betting Ledger</title>
  <meta name="theme-color" content="#020817" />

  <style>
    :root{
      --bg:#020817;
      --card:#0f172a;
      --border:#1f2937;
      --fg:#e5e7eb;
      --muted:#9ca3af;
      --accent:#22c55e;
      --accent-soft:#064e3b;
      --danger:#ef4444;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      padding:0;
      background:var(--bg);
      color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    }
    .container{
      max-width:980px;
      margin:0 auto;
      padding:12px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      margin-top:10px;
    }
    h1,h2,h3{
      margin:4px 0 8px;
      font-weight:600;
    }
    .small{
      font-size:12px;
      color:var(--muted);
    }
    button,input,select,textarea{
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#020817;
      color:var(--fg);
      font-size:14px;
      font-family:inherit;
    }
    button{
      cursor:pointer;
      font-weight:600;
      background:var(--accent);
      color:#022c22;
      border-color:#16a34a;
      transition:transform 0.05s ease, box-shadow 0.05s ease;
    }
    button:active{
      transform:scale(0.97);
      box-shadow:0 0 0 transparent;
    }
    button.secondary{
      background:#111827;
      color:var(--fg);
      border-color:var(--border);
    }
    button.danger{
      background:var(--danger);
      color:#111827;
      border-color:#b91c1c;
    }
    .grid{
      display:grid;
      gap:8px;
    }
    .cols-2{grid-template-columns:1fr 1fr;}
    .cols-3{grid-template-columns:repeat(3,1fr);}
    .right{text-align:right;}

    .summary{
      display:grid;
      gap:8px;
      grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
      margin-top:4px;
    }
    .sum-box{
      padding:8px;
      border-radius:12px;
      background:#020817;
      border:1px solid var(--border);
    }
    .sum-label{
      font-size:10px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.04em;
    }
    .sum-value{
      margin-top:4px;
      font-size:17px;
      font-weight:700;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:6px;
      table-layout:fixed;
    }
    th,td{
      padding:6px;
      border-bottom:1px solid var(--border);
      font-size:10px;
      vertical-align:middle;
    }
    th{
      color:var(--muted);
      font-weight:500;
      text-align:left;
      position:sticky;
      top:0;
      background:var(--card);
      z-index:1;
    }

    td input, td select{
      padding:4px;
      font-size:10px;
      background:#020817;
    }

    .hidden{display:none !important;}

    /* Date tabs row */
    .tabs-row{
      display:flex;
      gap:6px;
      overflow-x:auto;
      padding:4px 0;
      margin-top:4px;
    }
    .tab-pill{
      padding:6px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:11px;
      white-space:nowrap;
      cursor:pointer;
      color:var(--muted);
      flex:0 0 auto;
      background:#020817;
    }
    .tab-pill span{
      font-size:9px;
      margin-left:4px;
      color:var(--accent);
    }
    .tab-pill.active{
      background:var(--accent-soft);
      color:var(--accent);
      border-color:var(--accent);
    }

    /* Actions cell: big mobile-friendly buttons */
    .actions-cell{
      white-space:normal;
      overflow:visible;
    }
    .actions-cell button{
      width:100%;
      margin-bottom:4px;
      padding:8px;
      font-size:11px;
      border-radius:999px;
    }

    @media (max-width:720px){
      .container{padding:10px;}
      h1{font-size:19px;}
      h2{font-size:16px;}
      h3{font-size:14px;}
      button,input,select,textarea{font-size:13px;padding:9px;}
      th,td{font-size:9px;}
      .tab-pill{font-size:10px;padding:5px 10px;}
      .actions-cell button{font-size:11px;padding:8px;}
    }
  </style>
</head>
<body>
<div class="container">

  <!-- LOGIN -->
  <section id="loginCard" class="card">
    <h1>Betting Ledger</h1>
    <p class="small">
      Separate from your trading journal & expense tracker.
      Sign in with the same Firebase email/password.
    </p>
    <input id="email" type="email" placeholder="Email" autocomplete="username" />
    <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
    <button id="loginBtn">Login</button>
    <p id="loginErr" class="small" style="color:#fca5a5;"></p>
  </section>

  <!-- APP -->
  <section id="appCard" class="hidden">

    <!-- Header -->
    <div class="card grid cols-2" style="align-items:center;">
      <div>
        <h2>Betting Dashboard</h2>
        <div class="small">Pro ledger for betting trades only.</div>
      </div>
      <div class="right">
        <div id="userEmail" class="small"></div>
        <button id="logoutBtn" class="secondary" style="margin-top:4px;">Logout</button>
      </div>
    </div>

    <!-- Starting balance + summary -->
    <div class="card">
      <h3>Account & Summary</h3>
      <div class="grid cols-2" style="align-items:flex-end;">
        <div>
          <div class="small">Starting Balance</div>
          <input id="startBalance" type="number" step="0.01" />
        </div>
        <div>
          <button id="saveStartBalanceBtn" class="secondary">Save Starting Balance</button>
        </div>
      </div>

      <div class="summary">
        <div class="sum-box">
          <div class="sum-label">Total Stakes</div>
          <div id="sumStake" class="sum-value">$0.00</div>
        </div>
        <div class="sum-box">
          <div class="sum-label">Total Profit</div>
          <div id="sumProfit" class="sum-value">$0.00</div>
        </div>
        <div class="sum-box">
          <div class="sum-label">Total Loss</div>
          <div id="sumLoss" class="sum-value">$0.00</div>
        </div>
        <div class="sum-box">
          <div class="sum-label">Total Withdrawals</div>
          <div id="sumWithdraw" class="sum-value">$0.00</div>
        </div>
        <div class="sum-box">
          <div class="sum-label">Net P/L</div>
          <div id="sumPL" class="sum-value">$0.00</div>
        </div>
        <div class="sum-box">
          <div class="sum-label">Current Balance</div>
          <div id="sumBalance" class="sum-value">$0.00</div>
        </div>
      </div>
    </div>

    <!-- ADD BET -->
    <div class="card">
      <h3>Add Bet</h3>
      <div class="grid cols-2">
        <div>
          <div class="small">Date</div>
          <input id="betDate" type="date" />
        </div>
        <div>
          <div class="small">Book / Exchange</div>
          <input id="betBook" placeholder="e.g. Bet365, Pinnacle" />
        </div>
      </div>
      <div class="grid cols-2" style="margin-top:6px;">
        <div>
          <div class="small">Event / Market</div>
          <input id="betEvent" placeholder="e.g. EPL - Arsenal vs City" />
        </div>
        <div>
          <div class="small">Selection</div>
          <input id="betSelection" placeholder="e.g. Arsenal ML" />
        </div>
      </div>
      <div class="grid cols-3" style="margin-top:6px;">
        <div>
          <div class="small">Stake</div>
          <input id="betStake" type="number" step="0.01" />
        </div>
        <div>
          <div class="small">Odds (decimal)</div>
          <input id="betOdds" type="number" step="0.01" />
        </div>
        <div>
          <div class="small">Result</div>
          <select id="betResult">
            <option value="pending">Pending</option>
            <option value="won">Won</option>
            <option value="lost">Lost</option>
            <option value="void">Void</option>
          </select>
        </div>
      </div>
      <div class="grid cols-2" style="margin-top:6px;">
        <div>
          <div class="small">Withdrawal (optional)</div>
          <input id="betWithdrawal" type="number" step="0.01" placeholder="If you withdrew from bankroll" />
        </div>
        <div>
          <div class="small">Notes (optional)</div>
          <textarea id="betNotes" rows="2" placeholder="Reasoning, CLV, etc."></textarea>
        </div>
      </div>
      <button id="addBetBtn" style="margin-top:8px;">Save Bet</button>
      <p id="addErr" class="small" style="color:#fca5a5;"></p>
    </div>

    <!-- BETS + DATE TABS -->
    <div class="card">
      <h3>Bets</h3>

      <!-- Date tabs row -->
      <div id="dateTabs" class="tabs-row"></div>

      <!-- Filters -->
      <div class="grid cols-2">
        <input id="filterText" placeholder="Filter by event / selection / book" />
        <select id="filterStatus">
          <option value="all">All</option>
          <option value="pending">Pending</option>
          <option value="won">Won</option>
          <option value="lost">Lost</option>
          <option value="void">Void</option>
        </select>
      </div>

      <div class="history-wrap">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Book</th>
              <th>Sel</th>
              <th>Stake</th>
              <th>Odds</th>
              <th>Result</th>
              <th>P/L</th>
              <th>Wdr</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="betsRows"></tbody>
        </table>
      </div>
      <p class="small">
        Use the date pills to jump by day. Edit inline â†’ Save. Delete removes the bet.
        Withdrawals reduce balance but are not counted as profit/loss.
      </p>
    </div>

    <!-- DAILY LEDGER -->
    <div class="card">
      <h3>Daily Ledger</h3>
      <p class="small">
        Daily profit/loss, withdrawals, average win/loss, and running ending balance from your starting balance.
      </p>
      <div class="history-wrap">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Daily Profit</th>
              <th>Daily Loss</th>
              <th>Daily Wdr</th>
              <th>Avg Profit</th>
              <th>Avg Loss</th>
              <th>Start Bal</th>
              <th>End Bal</th>
            </tr>
          </thead>
          <tbody id="ledgerRows"></tbody>
        </table>
      </div>
    </div>

  </section>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import {
  getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import {
  getFirestore, collection, addDoc, getDocs, doc,
  getDoc, setDoc, updateDoc, deleteDoc,
  serverTimestamp, query, where
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyB5rvkKPst6V9-7HoqK1f27jQj6x7f8LiA",
  authDomain: "trading-journal-da4eb.firebaseapp.com",
  projectId: "trading-journal-da4eb",
  storageBucket: "trading-journal-da4eb.firebasestorage.app",
  messagingSenderId: "50906470929",
  appId: "1:50906470929:web:b9ad784e9ae86c06d42fb0",
  measurementId: "G-WR261BKTXL"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const $ = id => document.getElementById(id);
const fmt = n => "$" + (Number(n) || 0).toFixed(2);
const today = () => new Date().toISOString().slice(0,10);

const state = {
  bets: [],
  startBalance: 0,
  selectedDate: "all"
};

if ($("betDate")) $("betDate").value = today();

/* --- Auth --- */
const loginCard = $("loginCard");
const appCard   = $("appCard");
const loginErr  = $("loginErr");
const addErr    = $("addErr");
const userEmail = $("userEmail");

$("loginBtn").addEventListener("click", async () => {
  loginErr.textContent = "";
  try {
    const email = $("email").value.trim();
    const pass  = $("password").value;
    await signInWithEmailAndPassword(auth, email, pass);
  } catch (e) {
    loginErr.textContent = e.message || "Login failed";
  }
});

$("logoutBtn").addEventListener("click", () => signOut(auth));

onAuthStateChanged(auth, async (user) => {
  if (user) {
    loginCard.classList.add("hidden");
    appCard.classList.remove("hidden");
    userEmail.textContent = user.email || "";
    await loadSettings(user.uid);
    await loadBets(user.uid);
  } else {
    appCard.classList.add("hidden");
    loginCard.classList.remove("hidden");
    userEmail.textContent = "";
  }
});

/* --- Starting balance --- */
const startBalanceInput = $("startBalance");
const saveStartBtn = $("saveStartBalanceBtn");

async function loadSettings(uid){
  const ref = doc(db, "betting_settings", uid);
  const snap = await getDoc(ref);
  if (snap.exists()) {
    state.startBalance = Number(snap.data().startingBalance) || 0;
  } else {
    state.startBalance = 0;
    await setDoc(ref, {
      ownerUid: uid,
      startingBalance: 0,
      createdAt: serverTimestamp()
    });
  }
  startBalanceInput.value = state.startBalance;
  renderSummaryAndLedger();
}

saveStartBtn.addEventListener("click", async () => {
  const user = auth.currentUser;
  if (!user) return;
  const val = Number(startBalanceInput.value || 0);
  state.startBalance = val;
  const ref = doc(db, "betting_settings", user.uid);
  await setDoc(ref, {
    ownerUid: user.uid,
    startingBalance: val,
    updatedAt: serverTimestamp()
  }, { merge: true });
  renderSummaryAndLedger();
});

/* --- Helpers --- */
function computePL(stake, odds, result){
  stake = Number(stake)||0;
  odds  = Number(odds)||0;
  if (result === "won")  return (odds - 1) * stake;
  if (result === "lost") return -stake;
  return 0;
}

/* --- Add Bet --- */
$("addBetBtn").addEventListener("click", async () => {
  addErr.textContent = "";
  const user = auth.currentUser;
  if (!user) { addErr.textContent = "Not signed in."; return; }

  const date = $("betDate").value || today();
  const book = $("betBook").value.trim();
  const event = $("betEvent").value.trim();
  const selection = $("betSelection").value.trim();
  const stake = Number($("betStake").value || 0);
  const odds  = Number($("betOdds").value || 0);
  const result = $("betResult").value;
  const withdrawal = Number($("betWithdrawal").value || 0);
  const notes = $("betNotes").value.trim();

  if (!stake || !odds || !selection) {
    addErr.textContent = "Stake, odds, and selection are required.";
    return;
  }

  const pnl = computePL(stake, odds, result);

  try {
    await addDoc(collection(db, "betting_trades"), {
      ownerUid: user.uid,
      date, book, event, selection,
      stake, odds, result, pnl,
      withdrawal,
      notes,
      createdAt: serverTimestamp()
    });

    $("betStake").value = "";
    $("betOdds").value = "";
    $("betWithdrawal").value = "";
    $("betNotes").value = "";

    await loadBets(user.uid);
  } catch (e) {
    addErr.textContent = e.message || "Failed to save bet.";
  }
});

/* --- Load bets + tabs --- */
const betsRows     = $("betsRows");
const filterText   = $("filterText");
const filterStatus = $("filterStatus");
const dateTabs     = $("dateTabs");

async function loadBets(uid){
  const snap = await getDocs(
    query(collection(db, "betting_trades"), where("ownerUid","==",uid))
  );
  state.bets = snap.docs.map(d => ({ id:d.id, ...d.data() }));
  buildDateTabs();
  renderBets();
  renderSummaryAndLedger();
}

function buildDateTabs(){
  dateTabs.innerHTML = "";
  const dates = Array.from(
    new Set(state.bets.map(b => b.date).filter(Boolean))
  ).sort((a,b)=> b.localeCompare(a)); // latest first

  if (state.selectedDate !== "all" && !dates.includes(state.selectedDate)) {
    state.selectedDate = "all";
  }

  const allTab = document.createElement("div");
  allTab.className = "tab-pill" + (state.selectedDate==="all"?" active":"");
  allTab.textContent = "All";
  allTab.onclick = () => { state.selectedDate="all"; renderBets(); highlightTabs(); };
  dateTabs.appendChild(allTab);

  dates.forEach(d => {
    const dayPL = state.bets
      .filter(b => b.date === d)
      .reduce((s,b)=> s + (Number(b.pnl)||0) - (Number(b.withdrawal)||0), 0);
    const tab = document.createElement("div");
    tab.className = "tab-pill" + (state.selectedDate===d?" active":"");
    tab.innerHTML = `${d}<span>${dayPL>=0?"+":"-"}${Math.abs(dayPL).toFixed(0)}</span>`;
    tab.onclick = () => { state.selectedDate=d; renderBets(); highlightTabs(); };
    dateTabs.appendChild(tab);
  });
}

function highlightTabs(){
  const pills = dateTabs.querySelectorAll(".tab-pill");
  pills.forEach(p => p.classList.remove("active"));
  pills.forEach(p => {
    if (p.textContent.trim().startsWith("All") && state.selectedDate==="all") {
      p.classList.add("active");
    } else if (state.selectedDate!=="all" && p.textContent.startsWith(state.selectedDate)) {
      p.classList.add("active");
    }
  });
}

/* --- Render bets table --- */
function renderBets(){
  const txt = (filterText.value || "").toLowerCase();
  const status = filterStatus.value;
  betsRows.innerHTML = "";

  const filtered = state.bets.filter(b => {
    if (state.selectedDate !== "all" && b.date !== state.selectedDate) return false;
    if (status !== "all" && b.result !== status) return false;
    const blob = `${b.book||""} ${b.event||""} ${b.selection||""}`.toLowerCase();
    if (txt && !blob.includes(txt)) return false;
    return true;
  });

  filtered.sort((a,b)=>{
    const da = a.date || "";
    const db = b.date || "";
    if (da === db) {
      return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
    }
    return db.localeCompare(da);
  });

  filtered.forEach(bet => {
    const stake = Number(bet.stake)||0;
    const odds  = Number(bet.odds)||0;
    const pnl   = Number(bet.pnl)||0;
    const wdr   = Number(bet.withdrawal)||0;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="date" class="edit date" value="${bet.date || ""}"></td>
      <td><input class="edit book" value="${bet.book || ""}"></td>
      <td><input class="edit sel" value="${bet.selection || ""}"></td>
      <td><input type="number" step="0.01" class="edit stake" value="${stake}"></td>
      <td><input type="number" step="0.01" class="edit odds" value="${odds}"></td>
      <td>
        <select class="edit result">
          <option value="pending" ${bet.result==="pending"?"selected":""}>Pending</option>
          <option value="won" ${bet.result==="won"?"selected":""}>Won</option>
          <option value="lost" ${bet.result==="lost"?"selected":""}>Lost</option>
          <option value="void" ${bet.result==="void"?"selected":""}>Void</option>
        </select>
      </td>
      <td>${pnl.toFixed(2)}</td>
      <td><input type="number" step="0.01" class="edit wdr" value="${wdr || ""}"></td>
      <td class="actions-cell">
        <button class="saveBtn secondary">Save</button>
        <button class="delBtn danger">Delete</button>
      </td>
    `;

    tr.querySelector(".saveBtn").addEventListener("click", async () => {
      const nd = tr.querySelector(".date").value || bet.date;
      const nb = tr.querySelector(".book").value;
      const ns = tr.querySelector(".sel").value;
      const nStake = Number(tr.querySelector(".stake").value || 0);
      const nOdds  = Number(tr.querySelector(".odds").value || 0);
      const nRes   = tr.querySelector(".result").value;
      const nWdr   = Number(tr.querySelector(".wdr").value || 0);
      const nPL    = computePL(nStake, nOdds, nRes);

      try {
        await updateDoc(doc(db, "betting_trades", bet.id), {
          date: nd,
          book: nb,
          selection: ns,
          stake: nStake,
          odds: nOdds,
          result: nRes,
          pnl: nPL,
          withdrawal: nWdr
        });
        await loadBets(auth.currentUser.uid);
      } catch (e) {
        alert("Update failed: " + (e.message || e));
      }
    });

    tr.querySelector(".delBtn").addEventListener("click", async () => {
      if (!confirm("Delete this bet?")) return;
      try {
        await deleteDoc(doc(db, "betting_trades", bet.id));
        await loadBets(auth.currentUser.uid);
      } catch (e) {
        alert("Delete failed: " + (e.message || e));
      }
    });

    betsRows.appendChild(tr);
  });
}

/* --- Summary + Daily Ledger (with withdrawals) --- */
const sumStakeEl    = $("sumStake");
const sumProfitEl   = $("sumProfit");
const sumLossEl     = $("sumLoss");
const sumWithdrawEl = $("sumWithdraw");
const sumPLEl       = $("sumPL");
const sumBalanceEl  = $("sumBalance");
const ledgerRows    = $("ledgerRows");

function renderSummaryAndLedger(){
  const bets = state.bets;

  let totalStake = 0;
  let totalProfit = 0;
  let totalLoss = 0;
  let totalWithdraw = 0;
  let netPL = 0;

  const byDate = {};

  bets.forEach(b => {
    const d = b.date || "";
    if (!d) return;
    if (!byDate[d]) byDate[d] = [];
    byDate[d].push(b);

    const st = Number(b.stake)||0;
    const pl = Number(b.pnl)||0;
    const w  = Number(b.withdrawal)||0;

    totalStake += st;
    if (pl > 0) totalProfit += pl;
    if (pl < 0) totalLoss += pl;
    netPL += pl;
    totalWithdraw += w;
  });

  sumStakeEl.textContent    = fmt(totalStake);
  sumProfitEl.textContent   = fmt(totalProfit);
  sumLossEl.textContent     = fmt(Math.abs(totalLoss));
  sumWithdrawEl.textContent = fmt(totalWithdraw);
  sumPLEl.textContent       = (netPL >= 0 ? "" : "-") + fmt(Math.abs(netPL));
  const currentBalance = (state.startBalance || 0) + netPL - totalWithdraw;
  sumBalanceEl.textContent  = fmt(currentBalance);

  ledgerRows.innerHTML = "";
  const dates = Object.keys(byDate).sort(); // ascending

  let runningBalance = state.startBalance || 0;

  dates.forEach(d => {
    const list = byDate[d];
    let dayProfit = 0;
    let dayLoss = 0;
    let dayWithdraw = 0;
    let posCount = 0;
    let negCount = 0;

    list.forEach(b => {
      const pl = Number(b.pnl)||0;
      const w  = Number(b.withdrawal)||0;
      if (pl > 0){ dayProfit += pl; posCount++; }
      if (pl < 0){ dayLoss += pl;  negCount++; }
      dayWithdraw += w;
    });

    const net = dayProfit + dayLoss - dayWithdraw; // dayLoss negative
    const avgProfit = posCount ? dayProfit / posCount : 0;
    const avgLoss   = negCount ? Math.abs(dayLoss) / negCount : 0;

    const startBal = runningBalance;
    const endBal   = startBal + net;
    runningBalance = endBal;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d}</td>
      <td>${dayProfit ? fmt(dayProfit) : "$0.00"}</td>
      <td>${dayLoss ? fmt(Math.abs(dayLoss)) : "$0.00"}</td>
      <td>${dayWithdraw ? fmt(dayWithdraw) : "$0.00"}</td>
      <td>${avgProfit ? fmt(avgProfit) : "$0.00"}</td>
      <td>${avgLoss ? fmt(avgLoss) : "$0.00"}</td>
      <td>${fmt(startBal)}</td>
      <td>${fmt(endBal)}</td>
    `;
    ledgerRows.appendChild(tr);
  });
}

/* Filters */
filterText.addEventListener("input", renderBets);
filterStatus.addEventListener("change", renderBets);
</script>
</body>
</html>
